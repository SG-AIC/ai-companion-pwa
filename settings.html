<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI Companion">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#7c3aed">

    <!-- Icons -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%237c3aed'/%3E%3Cstop offset='100%25' style='stop-color:%233b82f6'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23g)'/%3E%3Ctext x='50' y='72' font-size='60' text-anchor='middle' fill='white'%3E⚡%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%237c3aed'/%3E%3Cstop offset='100%25' style='stop-color:%233b82f6'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23g)'/%3E%3Ctext x='50' y='72' font-size='60' text-anchor='middle' fill='white'%3E⚡%3C/text%3E%3C/svg%3E">
    <link rel="manifest" href="./manifest.json">

    <title>Einstellungen - AI Companion</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            -webkit-tap-highlight-color: transparent;
        }

        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin { animation: spin 1s linear infinite; }

        .menu-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="h-screen overflow-hidden">
    <div id="app" class="flex flex-col h-screen bg-gradient-to-br from-purple-50 via-white to-blue-50">

        <!-- Header -->
        <div class="bg-white/80 backdrop-blur-lg border-b border-gray-200 shadow-sm safe-area-top">
            <div class="max-w-4xl mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <a href="./" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </a>
                        <div>
                            <h1 class="text-xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                                Einstellungen
                            </h1>
                            <p class="text-xs text-gray-500">Konfiguriere deinen AI Companion</p>
                        </div>
                    </div>
                    <button id="menu-btn" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-4 safe-area-bottom">
            <div class="max-w-lg mx-auto space-y-4 fade-in">

                <!-- Timezone Section -->
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="p-4 flex items-center gap-4 border-b border-gray-100">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-indigo-600 flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900">Zeitzone</h3>
                            <p class="text-sm text-gray-500">Für Kalender und Email-Zeiten</p>
                        </div>
                    </div>

                    <div class="p-4">
                        <div class="space-y-3">
                            <label class="block">
                                <span class="text-sm font-medium text-gray-700">Zeitzone auswählen</span>
                                <select id="timezone-select" class="mt-1 block w-full rounded-xl border-gray-300 border-2 py-3 px-4 focus:border-purple-500 focus:ring focus:ring-purple-200 focus:ring-opacity-50 transition-colors">
                                    <option value="">Wird geladen...</option>
                                </select>
                            </label>

                            <div id="current-time" class="text-sm text-gray-500 flex items-center gap-2">
                                <span>Aktuelle Zeit:</span>
                                <span id="time-display" class="font-mono font-medium text-gray-700">--:--:--</span>
                            </div>

                            <button id="save-timezone-btn" onclick="saveTimezone()" class="w-full py-3 px-4 bg-gradient-to-r from-purple-500 to-blue-500 text-white font-medium rounded-xl hover:from-purple-600 hover:to-blue-600 transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span>Speichern</span>
                            </button>

                            <div id="save-status" class="text-center text-sm hidden"></div>
                        </div>
                    </div>
                </div>

                <!-- Quick Timezone Buttons -->
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-gray-100">
                        <h3 class="font-semibold text-gray-900">Schnellauswahl</h3>
                    </div>
                    <div class="p-4 grid grid-cols-2 gap-2">
                        <button onclick="setQuickTimezone('Europe/Berlin')" class="py-2 px-3 border-2 border-gray-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition-all text-sm font-medium text-gray-700">
                            Berlin (MEZ)
                        </button>
                        <button onclick="setQuickTimezone('Europe/Vienna')" class="py-2 px-3 border-2 border-gray-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition-all text-sm font-medium text-gray-700">
                            Wien (MEZ)
                        </button>
                        <button onclick="setQuickTimezone('Europe/Zurich')" class="py-2 px-3 border-2 border-gray-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition-all text-sm font-medium text-gray-700">
                            Zürich (MEZ)
                        </button>
                        <button onclick="setQuickTimezone('Europe/London')" class="py-2 px-3 border-2 border-gray-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition-all text-sm font-medium text-gray-700">
                            London (GMT)
                        </button>
                        <button onclick="setQuickTimezone('America/New_York')" class="py-2 px-3 border-2 border-gray-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition-all text-sm font-medium text-gray-700">
                            New York (EST)
                        </button>
                        <button onclick="setQuickTimezone('America/Los_Angeles')" class="py-2 px-3 border-2 border-gray-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition-all text-sm font-medium text-gray-700">
                            Los Angeles (PST)
                        </button>
                        <button onclick="setQuickTimezone('Asia/Tokyo')" class="py-2 px-3 border-2 border-gray-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition-all text-sm font-medium text-gray-700">
                            Tokyo (JST)
                        </button>
                        <button onclick="setQuickTimezone('UTC')" class="py-2 px-3 border-2 border-gray-200 rounded-xl hover:border-purple-400 hover:bg-purple-50 transition-all text-sm font-medium text-gray-700">
                            UTC
                        </button>
                    </div>
                </div>

                <!-- Info Section -->
                <div class="bg-blue-50 rounded-2xl border border-blue-200 p-4">
                    <div class="flex gap-3">
                        <svg class="w-5 h-5 text-blue-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="text-sm text-blue-700">
                            <p class="font-medium mb-1">Wozu dient die Zeitzone?</p>
                            <p class="text-blue-600">Die Zeitzone wird verwendet, um Kalendertermine und Email-Zeiten korrekt anzuzeigen. Microsoft 365 Events werden in deiner lokalen Zeit dargestellt.</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Menu Sidebar -->
        <div id="menu-sidebar" class="fixed inset-0 z-50 hidden">
            <div class="menu-overlay absolute inset-0" id="menu-overlay"></div>
            <div class="absolute right-0 top-0 bottom-0 w-72 bg-white shadow-2xl transform transition-transform safe-area-top">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-bold text-gray-900">Menü</h2>
                        <button id="close-menu-btn" class="p-2 hover:bg-gray-100 rounded-lg">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <nav class="p-4 space-y-2">
                    <a href="./" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-100 text-gray-700 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <span>Chat</span>
                    </a>

                    <a href="./history.html" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-100 text-gray-700 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>History & Memory</span>
                    </a>

                    <a href="./accounts.html" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-100 text-gray-700 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <span>Accounts</span>
                    </a>

                    <a href="./settings.html" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-purple-50 text-purple-700 font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span>Einstellungen</span>
                    </a>
                </nav>

                <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-200 safe-area-bottom">
                    <div class="text-xs text-gray-500 text-center">
                        AI Companion v1.0<br>
                        Made with ❤️
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'https://ai-companion-production-cd95.up.railway.app';
        const USER_ID = 'default_user';

        // Common timezones
        const COMMON_TIMEZONES = [
            { value: 'Europe/Berlin', label: 'Berlin, Frankfurt, München (MEZ/MESZ)' },
            { value: 'Europe/Vienna', label: 'Wien (MEZ/MESZ)' },
            { value: 'Europe/Zurich', label: 'Zürich (MEZ/MESZ)' },
            { value: 'Europe/Amsterdam', label: 'Amsterdam (MEZ/MESZ)' },
            { value: 'Europe/Paris', label: 'Paris (MEZ/MESZ)' },
            { value: 'Europe/Rome', label: 'Rom (MEZ/MESZ)' },
            { value: 'Europe/Madrid', label: 'Madrid (MEZ/MESZ)' },
            { value: 'Europe/London', label: 'London (GMT/BST)' },
            { value: 'Europe/Dublin', label: 'Dublin (GMT/IST)' },
            { value: 'Europe/Lisbon', label: 'Lissabon (WET/WEST)' },
            { value: 'Europe/Stockholm', label: 'Stockholm (MEZ/MESZ)' },
            { value: 'Europe/Oslo', label: 'Oslo (MEZ/MESZ)' },
            { value: 'Europe/Copenhagen', label: 'Kopenhagen (MEZ/MESZ)' },
            { value: 'Europe/Helsinki', label: 'Helsinki (OEZ/OESZ)' },
            { value: 'Europe/Athens', label: 'Athen (OEZ/OESZ)' },
            { value: 'Europe/Moscow', label: 'Moskau (MSK)' },
            { value: 'America/New_York', label: 'New York (EST/EDT)' },
            { value: 'America/Chicago', label: 'Chicago (CST/CDT)' },
            { value: 'America/Denver', label: 'Denver (MST/MDT)' },
            { value: 'America/Los_Angeles', label: 'Los Angeles (PST/PDT)' },
            { value: 'America/Toronto', label: 'Toronto (EST/EDT)' },
            { value: 'America/Vancouver', label: 'Vancouver (PST/PDT)' },
            { value: 'America/Sao_Paulo', label: 'São Paulo (BRT)' },
            { value: 'Asia/Tokyo', label: 'Tokyo (JST)' },
            { value: 'Asia/Shanghai', label: 'Shanghai, Peking (CST)' },
            { value: 'Asia/Hong_Kong', label: 'Hong Kong (HKT)' },
            { value: 'Asia/Singapore', label: 'Singapur (SGT)' },
            { value: 'Asia/Dubai', label: 'Dubai (GST)' },
            { value: 'Asia/Kolkata', label: 'Mumbai, Delhi (IST)' },
            { value: 'Asia/Bangkok', label: 'Bangkok (ICT)' },
            { value: 'Asia/Seoul', label: 'Seoul (KST)' },
            { value: 'Australia/Sydney', label: 'Sydney (AEST/AEDT)' },
            { value: 'Australia/Melbourne', label: 'Melbourne (AEST/AEDT)' },
            { value: 'Australia/Perth', label: 'Perth (AWST)' },
            { value: 'Pacific/Auckland', label: 'Auckland (NZST/NZDT)' },
            { value: 'UTC', label: 'UTC (Koordinierte Weltzeit)' }
        ];

        let currentTimezone = 'Europe/Berlin';

        // Initialize timezone select
        function initTimezoneSelect() {
            const select = document.getElementById('timezone-select');
            select.innerHTML = '';

            COMMON_TIMEZONES.forEach(tz => {
                const option = document.createElement('option');
                option.value = tz.value;
                option.textContent = tz.label;
                select.appendChild(option);
            });

            // Try to detect browser timezone
            const browserTz = Intl.DateTimeFormat().resolvedOptions().timeZone;

            // Load saved timezone from backend or localStorage
            loadSavedTimezone().then(savedTz => {
                currentTimezone = savedTz || browserTz || 'Europe/Berlin';
                select.value = currentTimezone;
                updateTimeDisplay();
            });

            // Update time display when selection changes
            select.addEventListener('change', () => {
                currentTimezone = select.value;
                updateTimeDisplay();
            });
        }

        async function loadSavedTimezone() {
            try {
                const response = await fetch(`${API_BASE_URL}/settings/${USER_ID}`);
                if (response.ok) {
                    const data = await response.json();
                    return data.timezone;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
            // Fallback to localStorage
            return localStorage.getItem('ai_companion_timezone');
        }

        function updateTimeDisplay() {
            const display = document.getElementById('time-display');
            try {
                const now = new Date();
                const options = {
                    timeZone: currentTimezone,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                };
                display.textContent = now.toLocaleTimeString('de-DE', options);
            } catch (e) {
                display.textContent = '--:--:--';
            }
        }

        function setQuickTimezone(tz) {
            const select = document.getElementById('timezone-select');
            select.value = tz;
            currentTimezone = tz;
            updateTimeDisplay();
        }

        async function saveTimezone() {
            const btn = document.getElementById('save-timezone-btn');
            const status = document.getElementById('save-status');
            const select = document.getElementById('timezone-select');
            const timezone = select.value;

            btn.disabled = true;
            btn.innerHTML = `
                <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                <span>Speichern...</span>
            `;

            try {
                const response = await fetch(`${API_BASE_URL}/settings/${USER_ID}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timezone: timezone })
                });

                if (response.ok) {
                    // Also save to localStorage as backup
                    localStorage.setItem('ai_companion_timezone', timezone);

                    status.className = 'text-center text-sm text-green-600';
                    status.textContent = '✓ Zeitzone gespeichert!';
                    status.classList.remove('hidden');

                    setTimeout(() => {
                        status.classList.add('hidden');
                    }, 3000);
                } else {
                    throw new Error('Server error');
                }
            } catch (error) {
                console.error('Error saving timezone:', error);

                // Save to localStorage anyway
                localStorage.setItem('ai_companion_timezone', timezone);

                status.className = 'text-center text-sm text-yellow-600';
                status.textContent = '⚠ Lokal gespeichert (Server nicht erreichbar)';
                status.classList.remove('hidden');
            }

            btn.disabled = false;
            btn.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>Speichern</span>
            `;
        }

        // Menu functionality
        function openMenu() {
            document.getElementById('menu-sidebar').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeMenu() {
            document.getElementById('menu-sidebar').classList.add('hidden');
            document.body.style.overflow = '';
        }

        document.getElementById('menu-btn').addEventListener('click', openMenu);
        document.getElementById('close-menu-btn').addEventListener('click', closeMenu);
        document.getElementById('menu-overlay').addEventListener('click', closeMenu);

        // Initialize
        initTimezoneSelect();

        // Update time every second
        setInterval(updateTimeDisplay, 1000);

        console.log('✅ Settings page loaded');
    </script>
</body>
</html>
